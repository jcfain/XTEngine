var wsUri,userAgent,remoteUserSettings,playingmediaItem,playingmediaItemNode,webSocket,deviceAddress,selectedInputDevice,selectedOutputDevice,deviceConnectionStatusInterval,serverRetryTimeout,videoStallTimeout,userFilterCriteria,filterDebounce,DeviceType={Serial:0,Network:1,Deo:2,Whirligig:3,Gamepad:4,XTPWeb:5,None:6},ConnectionStatus={Connected:0,Disconnected:1,Connecting:2,Error:3},ChannelType={None:0,Range:1,Switch:2,HalfRange:3},AxisDimension={None:0,Heave:1,Surge:2,Sway:3,Pitch:4,Roll:5,Yaw:6},MediaType={PlaylistInternal:0,Video:1,Audio:2,FunscriptType:3,VR:4},websocket=null,xtpConnected=!1,xtpFormDirty=!1,mediaListGlobal=[],sortedMedia=[],filteredMedia=[],funscriptChannels=[],currentChannelIndex=0,outputConnectionStatus=ConnectionStatus.Disconnected,serverRetryTimeoutTries=0,enableTextToSpeech=!0,systemVoices=[],speechNotInbrowser=!1,selectedVoiceIndex=0,speechPitch=5,speechRate=5,speechVolume=.5;document.addEventListener("keyup",keyboardShortcuts),getBrowserInformation();var userAgentIsDeo=-1!=userAgent.indexOf("Deo VR"),userAgentIsHereSphere=-1!=userAgent.indexOf("HereSphere"),userAgentIsMobile=-1!=userAgent.indexOf("Mobile");setDeoStyles(userAgentIsDeo);var settingsNode=document.getElementById("settingsModal"),thumbsContainerNode=document.getElementById("thumbsContainer"),videoMediaName=document.getElementById("videoMediaName"),sortByGlobal=JSON.parse(window.localStorage.getItem("sortBy")),showGlobal=JSON.parse(window.localStorage.getItem("show")),thumbSizeGlobal=JSON.parse(window.localStorage.getItem("thumbSize")),selectedSyncConnectionGlobal=JSON.parse(window.localStorage.getItem("selectedSyncConnection")),selectedOutputConnectionGlobal=JSON.parse(window.localStorage.getItem("selectedOutputConnection")),externalStreaming=JSON.parse(window.localStorage.getItem("externalStreaming"));toggleExternalStreaming(externalStreaming,!1);const skipToMoneyShotButton=document.getElementById("money-shot"),skipToNextActionButton=document.getElementById("next-action"),exitVideoButton=document.getElementById("exit-action");skipToMoneyShotButton.addEventListener("click",sendSkipToMoneyShot),skipToMoneyShotButton.addEventListener("click",onSkipToMoneyShotClick),skipToNextActionButton.addEventListener("click",sendSkipToNextActionClick),exitVideoButton.addEventListener("click",stopVideoClick),videoNode.addEventListener("loadeddata",onVideoLoad),videoNode.addEventListener("play",onVideoPlay),videoNode.addEventListener("playing",onVideoPlaying),videoNode.addEventListener("stalled",onVideoStall),videoNode.addEventListener("waiting",onVideoStall),videoNode.addEventListener("pause",onVideoPause),videoNode.addEventListener("volumechange",onVolumeChange),videoNode.addEventListener("ended",onVideoEnd),videoNode.addEventListener("timeupdate",onVideoTimeUpdate);const playNextButton=document.getElementById("play-next");playNextButton.addEventListener("click",playNextVideoClick);const playPreviousButton=document.getElementById("play-previous");playPreviousButton.addEventListener("click",playPreviousVideoClick);var saveStateNode=document.getElementById("saveState"),deviceConnectionStatusRetryButtonNodes=document.getElementsByName("deviceStatusRetryButton"),deviceConnectionStatusRetryButtonImageNodes=document.getElementsByName("connectionStatusIconImage");function debug(e){debugMode&&console.log(e)}function userError(e){alert(e)}function systemError(e){alert(e)}function sendWebsocketMessage(e,t){var n;websocket&&xtpConnected&&(n=t?{command:e,message:t}:{command:e},websocket.send(JSON.stringify(n)))}function onInputDeviceConnectionChange(e,t){selectedInputDevice=t,sendInputDeviceConnectionChange(t,e.checked),window.localStorage.setItem("selectedSyncConnection",parseInt(t,10)),sendMediaState()}function onOutputDeviceConnectionChange(e,t){selectedOutputDevice=t,sendOutputDeviceConnectionChange(t,e.checked),window.localStorage.setItem("selectedOutputConnection",parseInt(t,10)),sendMediaState()}function tcodeDeviceConnectRetry(){sendWebsocketMessage("connectOutputDevice",{deviceName:remoteUserSettings.connection.output.selectedDevice})}function sendTCode(e){sendWebsocketMessage("tcode",e)}function sendInputDeviceConnectionChange(e,t){sendWebsocketMessage("connectInputDevice",{deviceName:e,enabled:t})}function sendOutputDeviceConnectionChange(e,t){sendWebsocketMessage("connectOutputDevice",{deviceName:e,enabled:t})}function sendSkipToNextActionClick(){controlsVisible&&sendSkipToNextAction()}function sendSkipToNextAction(){sendWebsocketMessage("skipToNextAction")}function sendSkipToMoneyShot(){sendWebsocketMessage("skipToMoneyShot")}function restartXTP(){confirm("Are you sure you want restart XTP?")&&(sendWebsocketMessage("restartService"),closeSettings())}function initWebSocket(){try{debug("Connecting to web socket uri: "+(wsUri="ws://"+window.location.hostname+":"+remoteUserSettings.webSocketServerPort)),"function"==typeof MozWebSocket&&(WebSocket=MozWebSocket),websocket&&1==websocket.readyState&&websocket.close(),(websocket=new WebSocket(wsUri)).onopen=function(e){xtpConnected=!0,stopServerConnectionRetry(),serverRetryTimeoutTries=0,debug("CONNECTED"),updateSettingsUI(),sendMediaState()},websocket.onmessage=function(e){wsCallBackFunction(e),debug("MESSAGE RECIEVED: "+e.data)},websocket.onclose=function(e){debug("DISCONNECTED"),xtpConnected=!1,startServerConnectionRetry()},websocket.onerror=function(e){console.log("ERROR: "+e.data+", Address: "+wsUri),xtpConnected=!1,startServerConnectionRetry()}}catch(e){console.log("ERROR: "+e+", Address: "+wsUri),xtpConnected=!1,startServerConnectionRetry()}}function wsCallBackFunction(e){try{var t=JSON.parse(e.data);switch(t.command){case"outputDeviceStatus":setOutputConnectionStatus((n=t.message).deviceName,n.status,n.message);break;case"inputDeviceStatus":var n;setInputConnectionStatus((n=t.message).deviceName,n.status,n.message);break;case"mediaLoaded":document.getElementById("mediaLoading").style.display="none",getServerLibrary();break;case"mediaLoading":setMediaLoading();break;case"mediaLoadingStatus":setMediaLoadingStatus(t.message);break;case"updateThumb":var o=t.message,i=document.getElementById(o.id);if(i){var a=i.getElementsByTagName("img")[0];a.src="/thumb/"+o.thumb+"?"+(new Date).getTime(),o.errorMessage&&(a.title=o.errorMessage);var s=mediaListGlobal.findIndex((e=>e.id===o.id));mediaListGlobal[s].relativeThumb="/thumb/"+o.thumb,mediaListGlobal[s].thumbFileExists=!0}break;case"textToSpeech":onTextToSpeech(o=t.message);break;case"skipToNextAction":skipVideoTo(o=t.message);break;case"skipToMoneyShot":onSkipToMoneyShot();break}}catch(e){console.error(e.toString())}}function setMediaLoading(){clearMediaList(),document.getElementById("mediaLoading").style.display="flex",document.getElementById("noMedia").hidden=!0}function setMediaLoadingStatus(e){document.getElementById("loadingStatus").innerText=e}function onResizeVideo(){}function getBrowserInformation(){var e,t,n,o,i,a,s=navigator.userAgent;-1!=(i=s.indexOf("Opera"))?(e="Opera",t=s.substring(i+6),-1!=(i=s.indexOf("Version"))&&(t=s.substring(i+8))):-1!=(i=s.indexOf("MSIE"))?(e="Microsoft Internet Explorer",t=s.substring(i+5)):-1!=(i=s.indexOf("Chrome"))?(e="Chrome",t=s.substring(i+7)):-1!=(i=s.indexOf("Safari"))?(e="Safari",t=s.substring(i+7),-1!=(i=s.indexOf("Version"))&&(t=s.substring(i+8))):-1!=(i=s.indexOf("Firefox"))?(e="Firefox",t=s.substring(i+8)):(o=s.lastIndexOf(" ")+1)<(i=s.lastIndexOf("/"))&&(e=s.substring(o,i),t=s.substring(i+1),e.toLowerCase()==e.toUpperCase()&&(e=navigator.appName)),-1!=(a=t.indexOf(";"))&&(t=t.substring(0,a)),-1!=(a=t.indexOf(" "))&&(t=t.substring(0,a)),n=parseInt(""+t,10),isNaN(n)&&(t=""+parseFloat(navigator.appVersion),n=parseInt(navigator.appVersion,10));var r=document.createElement("div");r.innerHTML="Browser name  = "+e+"<br>Full version  = "+t+"<br>Major version = "+n+"<br>navigator.userAgent = "+navigator.userAgent+"<br>",userAgent=navigator.userAgent,document.getElementById("browserInfoTab").appendChild(r)}function setDeoStyles(e){if(e)for(var t=document.querySelectorAll("input[type='checkbox']"),n=0;n<t.length;n++)t[n].classList.remove("styled-checkbox");else for(t=document.getElementsByClassName("input[type='checkbox']"),n=0;n<t.length;n++)t[n].classList.add("styled-checkbox")}function getServerSettings(e){var t=new XMLHttpRequest;t.open("GET","/settings",!0),t.responseType="json",t.onload=function(e,n){200===t.status?(remoteUserSettings=t.response,funscriptChannels=Object.keys(remoteUserSettings.availableAxis).map((function(e){return remoteUserSettings.availableAxis[e].channel})),remoteUserSettings.availableAxisArray=Object.keys(remoteUserSettings.availableAxis).map((function(e){return remoteUserSettings.availableAxis[e]})),funscriptChannels.sort(),initWebSocket()):startServerConnectionRetry()}.bind(this),t.onerror=function(e,t){startServerConnectionRetry()},t.send()}function startServerConnectionRetry(){stopServerConnectionRetry(),setMediaLoading(),setMediaLoadingStatus("Waiting for reconnect..."),++serverRetryTimeoutTries<100?serverRetryTimeout=setTimeout((()=>{getServerSettings()}),5e3):setMediaLoadingStatus("Timed out while looking for server. Please refresh the page when the server has started again.")}function stopServerConnectionRetry(){null!=serverRetryTimeout&&(clearTimeout(serverRetryTimeout),serverRetryTimeout=void 0)}function updateSettingsUI(){setupSliders(),setupMotionModifiers(),setupConnectionsTab(),document.getElementById("tabLocalTab").onclick()}function getServerLibrary(){var e=new XMLHttpRequest;e.open("GET","/media",!0),e.responseType="json",e.onload=function(){200===e.status?(mediaListGlobal=e.response,updateMediaUI()):systemError("Error getting media list: "+err)},e.onerror=function(){systemError("Error getting media")},e.send()}function setInputConnectionStatus(e,t,n){var o="",i="";switch(t){case ConnectionStatus.Connected:o="://images/icons/check-mark-black.png",i="chartreuse";break;case ConnectionStatus.Connecting:o="://images/icons/reload.svg",i="yellow";break;case ConnectionStatus.Disconnected:o="://images/icons/x.svg",i="crimson";break;case ConnectionStatus.Error:o="://images/icons/error-black.png",i="red";break}var a=document.getElementById("deoVRStatus"),s=document.getElementById("whirligigStatus"),r=document.getElementById("xtpWebStatus"),d=document.getElementById("gamepadStatus");switch(e!=DeviceType.Gamepad&&(a.src="://images/icons/x.svg",a.style.backgroundColor="crimson",a.title="Disconnected",s.src="://images/icons/x.svg",s.style.backgroundColor="crimson",s.title="Disconnected",r.src="://images/icons/x.svg",r.style.backgroundColor="crimson",r.title="Disconnected"),e){case DeviceType.Deo:a.src=o,a.style.backgroundColor=i,a.title=n;break;case DeviceType.Whirligig:s.src=o,s.style.backgroundColor=i,s.title=n;break;case DeviceType.XTPWeb:r.src=o,r.style.backgroundColor=i,r.title=n;break;case DeviceType.Gamepad:d.src=o,d.style.backgroundColor=i,d.title=n;break}}function setOutputConnectionStatus(e,t,n){for(var o=0;o<deviceConnectionStatusRetryButtonNodes.length;o++){var i=deviceConnectionStatusRetryButtonNodes[o],a=deviceConnectionStatusRetryButtonImageNodes[o];i.title="TCode status: "+n,i.style.cursor="",i.disabled=!0;var s=document.getElementById("tcodeDeviceSettingsLink");switch(s.hidden=!0,outputConnectionStatus=t,t){case ConnectionStatus.Disconnected:i.style.backgroundColor="crimson",i.style.cursor="pointer",i.disabled=!1,a.src="://images/icons/x.svg",i.title+=": Check your devices connection and click this to retry";break;case ConnectionStatus.Connecting:i.style.backgroundColor="yellow",a.src="://images/icons/reload.svg";break;case ConnectionStatus.Connected:outputDeviceConnected=!0,i.style.backgroundColor="chartreuse",a.src="://images/icons/check-mark-black.png",remoteUserSettings.connection.output.selectedDevice==DeviceType.Network&&(s.href="http://"+remoteUserSettings.connection.networkAddress,s.hidden=!1);break;case ConnectionStatus.Error:i.style.backgroundColor="red",i.style.cursor="pointer",i.disabled=!1,a.src="://images/icons/error-black.png",i.title+=": Check your devices connection and click this to retry";break}}var r="",d="";switch(t){case ConnectionStatus.Connected:r="://images/icons/check-mark-black.png",d="chartreuse";break;case ConnectionStatus.Connecting:r="://images/icons/reload.svg",d="yellow";break;case ConnectionStatus.Disconnected:r="://images/icons/x.svg",d="crimson";break;case ConnectionStatus.Error:r="://images/icons/error-black.png",d="red";break}var c=document.getElementById("networkStatus"),l=document.getElementById("serialStatus");switch(c.src="://images/icons/x.svg",c.style.backgroundColor="crimson",c.title="Disconnected",l.src="://images/icons/x.svg",l.style.backgroundColor="crimson",l.title="Disconnected",e){case DeviceType.Network:c.src=r,c.style.backgroundColor=d,c.title=n;break;case DeviceType.Serial:l.src=r,l.style.backgroundColor=d,l.title=n;break}}function getMediaFunscripts(e,t){var n=funscriptChannels[currentChannelIndex],o=remoteUserSettings.availableAxis[n].trackName,i=new XMLHttpRequest,a=""===o?o:"."+o;i.open("GET",e+a+".funscript",!0),i.responseType="json",i.onload=function(){if(200===i.status){loadedFunscripts.push({channel:n,atList:[]});for(var o=loadedFunscripts.length-1,a=i.response,s=0;s<a.actions.length;s++){var r=a.actions[s],d=r.at;loadedFunscripts[o][d]=r.pos,loadedFunscripts[o].atList.push(d)}}++currentChannelIndex<funscriptChannels.length?getMediaFunscripts(e,t):(currentChannelIndex=0,videoNode.play(),console.log("Funscripts load finish"))},i.send()}function postServerSettings(){var e=new XMLHttpRequest;e.open("POST","/settings",!0),e.setRequestHeader("Content-Type","application/json"),e.onreadystatechange=function(){4===e.readyState&&(200!==e.status?onSaveFail(e.statusText):(onSaveSuccess(),markXTPFormClean()))},e.onerror=function(){onSaveFail(e.statusText)},e.send(JSON.stringify(remoteUserSettings))}function postMediaState(e){var t=new XMLHttpRequest;t.open("POST","/xtpweb",!0),t.setRequestHeader("Content-Type","application/json"),t.send(JSON.stringify(e)),t.oneload=function(){200!==t.status&&console.log("Error sending mediastate: "+t.statusText)},t.onerror=function(){console.log("Error sending mediastate: "+t.statusText)}}function onSaveSuccess(){saveStateNode.style.visibility="visible",saveStateNode.style.opacity="1",saveStateNode.style.color="green",saveStateNode.innerText="Save success",setTimeout((()=>{saveStateNode.style.visibility="hidden",saveStateNode.style.opacity="0"}),5e3)}function onSaveFail(e){saveStateNode.style.visibility="visible",saveStateNode.style.opacity="1",saveStateNode.style.color="red",saveStateNode.innerText="Save fail",saveStateNode.title=e}function updateMediaUI(){setThumbSize(thumbSizeGlobal,!1),sort(sortByGlobal,!1),loadMedia(sortedMedia=show(showGlobal,!1))}function clearMediaList(){var e=document.getElementById("mediaList");return removeAllChildNodes(e),e}function loadMedia(e){var t=clearMediaList(),n=document.getElementById("noMedia");if(!e||0==e.length)return n.innerHTML="No media found<br>Current filter: "+showGlobal,void(n.hidden=!1);n.hidden=!0;for(var o=function(e){return function(){showVideo(),playVideo(e)}},i=0,a=0,s=0,r=0,d=0;d<e.length;d++){var c=e[d];thumbSizeGlobal||(setThumbSize(c.thumbSize,!0),setThumbSize(c.thumbSize,!1)),i||(a=thumbSizeGlobal+.15*thumbSizeGlobal+"px",s=thumbSizeGlobal+(i=.25*thumbSizeGlobal)+"px",r=.35*i+"px");var l=document.createElement("div");l.id=c.id,l.className+="media-item",l.style.width=a,l.style.height=s,l.title=c.name;var u=document.createElement("a");u.className+="media-link",c.isMFS&&(l.className+=" media-item-mfs"),c.hasScript||(l.className+=" media-item-noscript"),u.onclick=o(c);var m=document.createElement("img");c.thumbFileExists?m.src="/thumb/"+c.relativeThumb:m.src="/thumb/"+c.thumbFileLoading,m.loading="lazy",m.style.width=thumbSizeGlobal+"px",m.style.height=thumbSizeGlobal-i+"px";var p=document.createElement("div");p.innerText=c.displayName,p.className+="name",p.style.width=a,p.style.height=i+"px",p.style.fontSize=r,l.appendChild(u),u.appendChild(m),u.appendChild(p),l.hidden=isFiltered(userFilterCriteria,l.innerText),t.appendChild(l),playingmediaItem&&playingmediaItem.id===c.id&&setPlayingMediaItem(c)}}function onThumbLoadError(e,t){e.onerror=null,t<3?(e.src="://images/icons/loading.png",e.onerror=onThumbLoadError(e,2)):e.src="://images/icons/error.png"}function removeAllChildNodes(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function sort(e,t){switch(e||(e="nameAsc"),e){case"dateDesc":mediaListGlobal.sort((function(e,t){return new Date(t.modifiedDate)-new Date(e.modifiedDate)}));break;case"dateAsc":mediaListGlobal.sort((function(e,t){return new Date(e.modifiedDate)-new Date(t.modifiedDate)}));break;case"nameAsc":mediaListGlobal.sort((function(e,t){var n=e.displayName.toUpperCase(),o=t.displayName.toUpperCase();return n<o?-1:n>o?1:void 0}));break;case"nameDesc":mediaListGlobal.sort((function(e,t){var n=e.displayName.toUpperCase(),o=t.displayName.toUpperCase();return o<n?-1:o>n?1:void 0}));break}t?(window.localStorage.setItem("sortBy",JSON.stringify(e)),sortByGlobal=e):e&&document.getElementById(e.toString()).click()}function show(e,t){e||(e="All");var n=[];switch(e){case"All":n=mediaListGlobal;break;case"3DOnly":n=mediaListGlobal.filter((e=>e.type===MediaType.VR));break;case"2DAndAudioOnly":n=mediaListGlobal.filter((e=>e.type===MediaType.Audio||e.type===MediaType.Video));break}return t?(window.localStorage.setItem("show",JSON.stringify(e)),showGlobal=e):e&&document.getElementById(e.toString()).click(),n}function filter(e){filteredMedia=[],filterDebounce&&clearTimeout(filterDebounce),filterDebounce=setTimeout((function(){var t=document.getElementById("filterInput");t.enabled=!1,userFilterCriteria=e;var n=document.getElementsByClassName("media-item");for(var o of n)o.hidden=isFiltered(e,o.textContent),o.hidden||filteredMedia.push(mediaListGlobal.find((e=>e.id===o.id)));t.enabled=!0,filterDebounce=void 0}),1e3)}function isFiltered(e,t){return!(!e||0==e.trim().length)&&!t.trim().toUpperCase().includes(e.trim().toUpperCase())}function onClickExternalStreamingCheckbox(e){toggleExternalStreaming(e.checked,!0)}function toggleExternalStreaming(e,t){t?(externalStreaming=e,window.localStorage.setItem("externalStreaming",JSON.stringify(e))):document.getElementById("externalStreamingCheckbox").checked=e,e&&stopVideo()}function setupTextToSpeech(){if("undefined"==typeof speechSynthesis)return speechNotInbrowser=!0,void disableTextToSpeech();void 0!==speechSynthesis.onvoiceschanged?speechSynthesis.onvoiceschanged=setupVoices:setTimeout((function(){setupVoices()}),1e3),null===(selectedVoiceIndex=JSON.parse(window.localStorage.getItem("selectedVoiceIndex")))&&(selectedVoiceIndex=0,window.localStorage.setItem("selectedVoiceIndex",JSON.stringify(selectedVoiceIndex))),null===(enableTextToSpeech=JSON.parse(window.localStorage.getItem("enableTextToSpeech")))&&(enableTextToSpeech=!0,window.localStorage.setItem("enableTextToSpeech",JSON.stringify(enableTextToSpeech))),toggleEnableTextToSpeech(enableTextToSpeech,!1),null===(speechPitch=JSON.parse(window.localStorage.getItem("speechPitch")))&&(speechPitch=1,window.localStorage.setItem("speechPitch",JSON.stringify(speechPitch))),toggleSpeechPitchChange(speechPitch,!1),null===(speechRate=JSON.parse(window.localStorage.getItem("speechRate")))&&(speechRate=1,window.localStorage.setItem("speechRate",JSON.stringify(speechRate))),null===(speechVolume=JSON.parse(window.localStorage.getItem("speechVolume")))&&(speechVolume=.5,window.localStorage.setItem("speechVolume",JSON.stringify(speechVolume))),toggleSpeechVolumeChange(speechVolume,!1)}function setupVoices(){systemVoices=speechSynthesis.getVoices();for(var e=document.getElementById("voiceSelect"),t=0;t<systemVoices.length;t++){var n=document.createElement("option");n.textContent=systemVoices[t].name+" ("+systemVoices[t].lang+")",n.value=t,systemVoices[t].default&&(n.textContent+=" â€” DEFAULT"),n.setAttribute("data-lang",systemVoices[t].lang),n.setAttribute("data-name",systemVoices[t].name),e.appendChild(n)}e.value=selectedVoiceIndex}function onVoiceSelect(e){selectedVoiceIndex=e,window.localStorage.setItem("selectedVoiceIndex",JSON.stringify(selectedVoiceIndex)),onTextToSpeech("Hello I am "+systemVoices[selectedVoiceIndex].name)}function onTextToSpeech(e){if(e&&enableTextToSpeech&&"undefined"!=typeof speechSynthesis&&systemVoices&&systemVoices.length>0){var t=new SpeechSynthesisUtterance;t.voice=systemVoices[selectedVoiceIndex],t.volume=speechVolume,t.rate=speechRate,t.pitch=speechPitch,t.text=e,window.speechSynthesis.speak(t)}}function onEnableTextToSpeechClick(e){toggleEnableTextToSpeech(e.checked,!0)}function toggleEnableTextToSpeech(e,t){t?(enableTextToSpeech=e,window.localStorage.setItem("enableTextToSpeech",JSON.stringify(e)),e&&onTextToSpeech("Voice enabled")):document.getElementById("enableTextToSpeech").checked=e,document.getElementsByName("voiceFormElement").forEach((t=>{t.style.display=e?"grid":"none"}))}function onSpeechPitchChange(e){toggleSpeechPitchChange(e,!0)}function toggleSpeechPitchChange(e,t){t?(speechPitch=e,window.localStorage.setItem("speechPitch",JSON.stringify(e)),onTextToSpeech("Pitch changed to "+e)):document.getElementById("speechPitch").value=e}function onSpeechRateChange(e){toggleSpeechRateChange(e,!0)}function toggleSpeechRateChange(e,t){t?(speechRate=e,window.localStorage.setItem("speechRate",JSON.stringify(e)),onTextToSpeech("Rate changed to "+e)):document.getElementById("speechRate").value=e}function onSpeechVolumeChange(e){toggleSpeechVolumeChange(e,!0)}function toggleSpeechVolumeChange(e,t){t?(speechVolume=e,window.localStorage.setItem("speechVolume",JSON.stringify(e)),onTextToSpeech("Volume changed to "+e)):document.getElementById("speechVolume").value=e}function disableTextToSpeech(e){var t=document.getElementById("textToSpeechUnavailable");t.hidden=!1,e&&(t.innerText=e);var n=document.getElementById("enableTextToSpeech");n.title="Text to speech is not available in your browser.",n.enabled=!1,n.checked=!1,toggleEnableTextToSpeech(!1,!0)}function playVideo(e){if(externalStreaming)if(userAgentIsHereSphere){var t="/media"+e.relativePath,n=document.createElement("A");n.href=t,n.download=t,document.body.appendChild(n),n.click(),document.body.removeChild(n)}else window.open("/media"+e.relativePath);else{if(playingmediaItem){if(playingmediaItem.id===e.id)return;clearPlayingMediaItem()}dataLoading(),setPlayingMediaItem(e),videoSourceNode.setAttribute("src","/media"+e.relativePath),videoNode.setAttribute("title",e.name),videoMediaName.innerText=e.name,videoNode.setAttribute("poster","/thumb/"+e.relativeThumb),videoNode.load()}}function stopVideoClick(){controlsVisible&&stopVideo()}function stopVideo(){hideVideo(),videoNode.pause(),videoSourceNode.setAttribute("src",""),videoNode.removeAttribute("title"),videoNode.removeAttribute("poster"),videoMediaName.innerText="",videoNode.load(),playingmediaItem&&(playingmediaItem.playing=!1,sendMediaState(),clearPlayingMediaItem())}function skipVideoTo(e){videoNode&&playingmediaItem&&(videoNode.currentTime=e)}function onSkipToMoneyShotClick(){controlsVisible&&onSkipToMoneyShot()}function onSkipToMoneyShot(){if(playingmediaItem){var e=playingmediaItem.metaData.moneyShotSecs;e<1&&(e=videoNode.duration-.1*videoNode.duration),skipVideoTo(e)}}function onToggleFilterInput(e){document.getElementById("filterInput").classList.toggle("hidden"),e.classList.toggle("icon-button-down")}function setPlayingMediaItem(e){playingmediaItem=e,(playingmediaItemNode=document.getElementById(e.id)).classList.add("media-item-playing")}function clearPlayingMediaItem(){playingmediaItemNode.classList.remove("media-item-playing"),playingmediaItem=null,playingmediaItemNode=null}setupTextToSpeech(),getServerSettings(),debugMode=!0;var sendTcodeDebouncer,debouncer,timer1=0,timer2=Date.now();function onVideoTimeUpdate(e){xtpConnected&&selectedInputDevice==DeviceType.XTPWeb&&(timer2-timer1>=1e3&&(timer1=timer2,sendMediaState()),timer2=Date.now())}function onVideoLoading(e){debug("Data loading"),videoStallTimeout&&clearTimeout(videoStallTimeout),dataLoading(),playingmediaItem&&(playingmediaItem.loaded=!1)}function onVideoLoad(e){debug("Data loaded"),debug("Duration: "+videoNode.duration),playingmediaItem&&(playingmediaItem.loaded=!0)}function onVideoPlay(e){debug("Video play"),playingmediaItem&&(playingmediaItem.playing=!0),sendMediaState()}function onVideoPause(e){debug("Video pause"),playingmediaItem&&(playingmediaItem.playing=!1),sendMediaState()}function onVideoStall(e){debug("Video stall"),dataLoading(),playingmediaItem&&(playingmediaItem.playing=!1),sendMediaState(),videoStallTimeout=setTimeout((()=>{playNextVideo(),videoStallTimeout=void 0}),2e4)}function onVideoPlaying(e){debug("Video playing"),videoStallTimeout&&clearTimeout(videoStallTimeout),playingmediaItem&&(playingmediaItem.playing=!0),sendMediaState()}function onVolumeChange(){window.localStorage.setItem("volume",videoNode.volume)}function onVideoEnd(e){playNextVideo()}function playNextVideoClick(){controlsVisible&&playNextVideo()}function playNextVideo(){if(0!=sortedMedia.length){var e=JSON.parse(JSON.stringify(sortedMedia));if(playingmediaItem){filteredMedia.length>0&&(e=filteredMedia);var t=e.findIndex((e=>e.path===playingmediaItem.path));t++}else t=0;t<e.length?playVideo(e[t]):playVideo(e[0])}}function playPreviousVideoClick(){controlsVisible&&playPreviousVideo()}function playPreviousVideo(){if(0!=sortedMedia.length){var e=JSON.parse(JSON.stringify(sortedMedia));if(playingmediaItem){filteredMedia.length>0&&(e=filteredMedia);var t=e.findIndex((e=>e.path===playingmediaItem.path));t--}else t=-1;playVideo(t<0?e[e.length-1]:e[t])}}function setThumbSize(e,t){t?(window.localStorage.setItem("thumbSize",parseInt(e,10)),thumbSizeGlobal=parseInt(e,10)):e&&document.getElementById(e.toString()).click()}function sendMediaState(){selectedInputDevice==DeviceType.XTPWeb&&postMediaState(playingmediaItem?{path:playingmediaItem.path,playing:playingmediaItem.playing,currentTime:videoNode.currentTime,duration:videoNode.duration,playbackSpeed:videoNode.speed}:{path:void 0,playing:!1,currentTime:0,duration:0,playbackSpeed:1})}function onFunscriptWorkerThreadRecieveMessage(e){var t;switch(isMediaFunscriptPlaying=!0,(t="string"==typeof e.data?JSON.parse(e.data):e.data).command){case"sendTcode":sendTcode(t.tcode);break;case"getMediaState":sendMediaState();break;case"end":funscriptSyncWorker.terminate(),funscriptSyncWorker=null;break}}function openSettings(){settingsNode.style.visibility="visible",settingsNode.style.opacity=1,document.getElementById("settingsTabs").style.display="block",speechNotInbrowser||systemVoices&&0!==systemVoices.length||disableTextToSpeech("No voices found")}function closeSettings(){settingsNode.style.visibility="hidden",settingsNode.style.opacity=0,document.getElementById("settingsTabs").style.display="none"}function tabClick(e,t){for(var n=document.getElementsByClassName("tab-section-tab"),o=0;o<n.length;o++){if(o!=t)n[o].style.backgroundColor="#5E6B7F"}var i=document.getElementsByClassName("tab-content");for(o=0;o<i.length;o++)if(o!=t){var a=i[o];a.style.display="none",a.style.opacity="0"}i[t].style.display="block",i[t].style.opacity="1",e.style.backgroundColor="#8DA1BF"}function showChange(e){sort(sortByGlobal,!0),loadMedia(sortedMedia=show(e,!0))}function sortChange(e){sort(e,!0),loadMedia(sortedMedia=show(showGlobal,!0))}function thumbSizeChange(e){setThumbSize(e,!0),loadMedia(sortedMedia=show(showGlobal,!0))}async function setupSliders(){for(var e=remoteUserSettings.availableAxisArray,t=document.getElementById("tabTCode"),n=0;n<e.length;n++){var o=e[n],i=document.createElement("div");i.classList.add("formElement");var a=document.createElement("label");a.classList.add("range-label"),a.innerText=o.friendlyName,a.for=o.channel,i.appendChild(a);var s=document.createElement("section");s.classList.add("range-slider"),s.id=o.channel,i.appendChild(s);var r=document.createElement("span");r.classList.add("range-values"),s.appendChild(r);var d=document.createElement("input");d.type="range",d.min=o.min,d.max=o.max-1,d.value=o.userMin;var c=document.createElement("input");c.type="range",c.min=o.min+1,c.max=o.max,c.value=o.userMax,userAgentIsDeo?(i.style.height="50px",a.style.height="50px"):(d.classList.add("range-input"),c.classList.add("range-input")),d.oninput=function(e,t,n,o){var i=parseInt(e.value),a=parseInt(t.value),s=Math.round((a+i)/2);n.innerText=i+" - "+s+" - "+a,a<i&&(t.value=i+1,remoteUserSettings.availableAxis[o.channel].userMax=t.value),remoteUserSettings.availableAxis[o.channel].userMin=i,remoteUserSettings.availableAxis[o.channel].userMid=s,sendTCode(o.channel+e.value.toString().padStart(4,"0")+"S2000"),markXTPFormDirty()}.bind(d,d,c,r,o),c.oninput=function(e,t,n,o){var i=parseInt(e.value),a=parseInt(t.value),s=Math.round((a+i)/2);n.innerText=i+" - "+s+" - "+a,i>a&&(e.value=a-1,remoteUserSettings.availableAxis[o.channel].userMin=e.value),remoteUserSettings.availableAxis[o.channel].userMax=a,remoteUserSettings.availableAxis[o.channel].userMid=s,sendTCode(o.channel+t.value.toString().padStart(4,"0")+"S2000"),markXTPFormDirty()}.bind(c,d,c,r,o),s.appendChild(d),s.appendChild(c);var l=parseInt(d.value),u=parseInt(c.value),m=Math.round((u+l)/2);r.innerText=l+" - "+m+" - "+u,t.appendChild(i)}}async function setupMotionModifiers(){var e=document.getElementById("tabFunscript");(r=document.createElement("div")).classList.add("formElement");var t=document.createElement("div");t.classList.add("tab-content-header");var n=document.createElement("div");n.innerText="Motion modifier",n.classList.add("tab-content-header-main");var o=document.createElement("div");o.classList.add("tab-content-header-eyebrow"),o.innerText="Add random motion to other channels",t.appendChild(n),t.appendChild(o),(d=document.createElement("label")).innerText="Enabled",d.for="multiplierEnabled",(c=document.createElement("section")).classList.add("form-group-section"),c.id="multiplierEnabled",(l=document.createElement("input")).id="multiplierEnabled",l.type="checkbox",l.checked=remoteUserSettings.multiplierEnabled,l.oninput=function(e){remoteUserSettings.multiplierEnabled=e.target.checked,toggleMotionModifierState(e.target.checked),markXTPFormDirty()}.bind(l),c.appendChild(l);["Modifier","Link to MFS","Speed"].forEach((e=>{var t=document.createElement("div");t.classList.add("form-group-control"),t.classList.add("form-group-control-header");var n=document.createElement("span");n.innerText=e,t.appendChild(n),c.appendChild(t)})),r.appendChild(d),r.appendChild(c),e.appendChild(t),e.appendChild(r);for(var i=remoteUserSettings.availableAxisArray,a=0;a<i.length;a++){var s=i[a];if(s.dimension!==AxisDimension.Heave){var r,d,c;(r=document.createElement("div")).classList.add("formElement"),(d=document.createElement("label")).innerText=s.friendlyName,d.for=s.channel,r.appendChild(d),(c=document.createElement("section")).setAttribute("name","motionModifierSection"),c.classList.add("form-group-section"),c.id=s.channel;var l,u=document.createElement("div");u.classList.add("form-group-control"),(l=document.createElement("input")).setAttribute("name","motionModifierInput"),l.type="checkbox",l.checked=s.multiplierEnabled,l.oninput=function(e,t){remoteUserSettings.availableAxisArray[e].multiplierEnabled=t.target.checked,markXTPFormDirty()}.bind(l,a);var m=document.createElement("input");m.setAttribute("name","motionModifierInput"),m.value=s.multiplierValue,m.oninput=function(e,t){var n=parseFloat(t.target.value);n&&(remoteUserSettings.availableAxisArray[e].multiplierValue=n,markXTPFormDirty())}.bind(m,a),u.appendChild(l),u.appendChild(m);var p=document.createElement("div");p.classList.add("form-group-control");var g=document.createElement("input");g.setAttribute("name","motionModifierInput"),g.type="checkbox",g.checked=s.linkToRelatedMFS,g.oninput=function(e,t){remoteUserSettings.availableAxisArray[e].linkToRelatedMFS=t.target.checked,markXTPFormDirty()}.bind(g,a);var h=document.createElement("select");h.setAttribute("name","motionModifierInput"),i.forEach((e=>{if(e.channel!==s.channel){var t=document.createElement("option");t.innerHTML=e.friendlyName,t.value=e.channel,h.appendChild(t)}})),h.value=s.relatedChannel,h.oninput=function(e,t){remoteUserSettings.availableAxisArray[e].relatedChannel=t.target.value,markXTPFormDirty()}.bind(h,a),p.appendChild(g),p.appendChild(h);var y=document.createElement("div");y.classList.add("form-group-control");var v=document.createElement("input");v.setAttribute("name","motionModifierInput"),v.type="checkbox",v.checked=s.damperEnabled,v.oninput=function(e,t){remoteUserSettings.availableAxisArray[e].damperEnabled=t.target.checked,markXTPFormDirty()}.bind(v,a);var S=document.createElement("input");S.setAttribute("name","motionModifierInput"),S.value=s.damperValue,S.oninput=function(e,t){var n=parseFloat(t.target.value);n&&(remoteUserSettings.availableAxisArray[e].damperValue=n,markXTPFormDirty())}.bind(S,a),y.appendChild(v),y.appendChild(S),c.appendChild(u),c.appendChild(p),c.appendChild(y),r.appendChild(c),e.appendChild(r)}}toggleMotionModifierState(remoteUserSettings.multiplierEnabled),setUpInversionMotionModifier()}function toggleMotionModifierState(e){document.getElementsByName("motionModifierInput").forEach((t=>{t.disabled=!e}))}async function setUpInversionMotionModifier(){var e=document.getElementById("tabFunscript");(a=document.createElement("div")).classList.add("formElement");var t=document.createElement("div");t.classList.add("tab-content-header");var n=document.createElement("div");n.classList.add("tab-content-header-eyebrow"),n.innerText="Invert motion of channels",t.appendChild(n),e.appendChild(t);for(var o=remoteUserSettings.availableAxisArray,i=0;i<o.length;i++){var a,s=o[i];(a=document.createElement("div")).classList.add("formElement");var r=document.createElement("label");r.innerText=s.friendlyName,r.for=s.channel+"Inverted",a.appendChild(r);var d=document.createElement("section");d.setAttribute("name","motionModifierInvertedSection"),d.classList.add("form-group-section"),d.id=s.channel+"Inverted";var c=document.createElement("div");c.classList.add("form-group-control");var l=document.createElement("input");l.setAttribute("name","motionModifierInputInverted"),l.type="checkbox",l.checked=s.inverted,l.oninput=function(e,t){remoteUserSettings.availableAxisArray[e].inverted=t.target.checked,markXTPFormDirty()}.bind(l,i),c.appendChild(l),d.appendChild(c),a.appendChild(d),e.appendChild(a)}}function markXTPFormDirty(){xtpFormDirty=!0,document.getElementById("saveToXTPButton").disabled=!1}function markXTPFormClean(){xtpFormDirty=!1,document.getElementById("saveToXTPButton").disabled=!0}function setupConnectionsTab(){switch(selectedInputDevice=remoteUserSettings.connection.input.selectedDevice,selectedSyncConnectionGlobal&&selectedSyncConnectionGlobal!=selectedInputDevice&&(sendInputDeviceConnectionChange(selectedSyncConnectionGlobal,!0),selectedInputDevice=selectedSyncConnectionGlobal),selectedInputDevice){case DeviceType.Deo:document.getElementById("connectionDeoVR").checked=!0;break;case DeviceType.Whirligig:document.getElementById("connectionWhirligig").checked=!0;break;case DeviceType.XTPWeb:document.getElementById("connectionXTPWeb").checked=!0;break;case DeviceType.None:document.getElementById("connectionInputNone").checked=!0;break}switch(document.getElementById("deoVRAddress").value=remoteUserSettings.connection.input.deoAddress,document.getElementById("deoVRPort").value=remoteUserSettings.connection.input.deoPort,document.getElementById("connectionGamepad").checked=remoteUserSettings.connection.input.gamePadEnabled,selectedOutputDevice=remoteUserSettings.connection.output.selectedDevice,selectedOutputConnectionGlobal&&selectedOutputConnectionGlobal!=selectedOutputDevice&&(sendOutputDeviceConnectionChange(selectedOutputConnectionGlobal,!0),selectedOutputDevice=selectedOutputConnectionGlobal),selectedOutputDevice){case DeviceType.None:document.getElementById("connectionOutputNone").checked=!0;break;case DeviceType.Network:document.getElementById("connectionNetwork").checked=!0;break;case DeviceType.Serial:document.getElementById("connectionSerial").checked=!0;break}document.getElementById("networkAddress").value=remoteUserSettings.connection.output.networkAddress,document.getElementById("networkPort").value=remoteUserSettings.connection.output.networkPort,document.getElementById("serialPort").value=remoteUserSettings.connection.output.serialPort}function webSocketAddressChange(e){debouncer&&clearTimeout(debouncer),debouncer=setTimeout((function(){debouncer=null,deviceAddress=document.getElementById("webSocketAddress").value,window.localStorage.setItem("webSocketAddress",value)}),500)}function defaultLocalSettings(){confirm("Are you sure you want to reset ALL local settings to default? Note: This only resets the settings in this browser. Your settings stored in XTP will remain.")&&(window.localStorage.clear(),window.location.reload())}function deleteLocalSettings(){confirm("Are you sure you want to delete ALL settings from localStorage and close the window?")&&(window.localStorage.clear(),window.close())}function onDeoVRAddressChange(e){e.value&&0!==e.value.trim().length?(remoteUserSettings.connection.input.deoAddress=e.value.trim(),markXTPFormDirty()):userError("Invalid Deo/Heresphere network address")}function onDeoVRPortChange(e){e.value&&0!==e.value.trim().length?(remoteUserSettings.connection.input.deoPort=e.value.trim(),markXTPFormDirty()):userError("Invalid Deo/Heresphere network port")}function onNetworkAddressChange(e){e.value&&0!==e.value.trim().length?(remoteUserSettings.connection.output.networkAddress=e.value.trim(),markXTPFormDirty()):userError("Invalid network address")}function onNetworkPortChange(e){e.value&&0!==e.value.trim().length?(remoteUserSettings.connection.output.networkPort=e.value.trim(),markXTPFormDirty()):userError("Invalid network port")}function onSerialPortChange(e){remoteUserSettings.connection.output.serialPort=e.value,markXTPFormDirty()}function keyboardShortcuts(e){if(!filterDebounce){const{key:t}=e;switch(t){case"k":togglePlay(),animatePlayback(),videoNode.paused?showControls():hideControls();break;case"m":toggleMute();break;case"f":toggleFullScreen();break;case"p":togglePip();break;case"ArrowRight":playNextVideo();break;case"ArrowLeft":playPreviousVideo();break;case"+":volumeUp();break;case"-":volumeDown();break;case"a":sendSkipToNextAction();break;case"c":onSkipToMoneyShot();break;case"x":stopVideoClick();break}}}